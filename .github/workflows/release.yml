name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Debug - List files
        run: |
          echo "Current directory: $(pwd)"
          echo "Files in current directory:"
          ls -la
          echo "Checking if gradlew exists:"
          ls -la gradlew || echo "gradlew not found"
      
      - name: Make gradlew executable
        run: chmod +x gradlew
      
      - name: Debug - Check gradlew after chmod
        run: |
          echo "Checking gradlew permissions after chmod:"
          ls -la gradlew
          echo "Testing gradlew execution:"
          ./gradlew --version || echo "gradlew execution failed"
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Build GitHub variant (with auto-updater)
        run: ./gradlew assembleGithubRelease
        
      - name: Build Store variant (without auto-updater)
        run: ./gradlew assembleStoreRelease
        
      - name: Rename APK files with proper naming convention
        run: |
          # Get version from gradle.properties or build.gradle.kts
          VERSION=$(grep 'versionName = ' app/build.gradle.kts | sed 's/.*versionName = "\([^"]*\)".*/\1/')
          echo "Version detected: $VERSION"
          
          # Rename GitHub variant
          mv app/build/outputs/apk/github/release/app-github-release-unsigned.apk app/build/outputs/apk/github/release/SpeakThat-v${VERSION}.apk
          
          # Rename Store variant  
          mv app/build/outputs/apk/store/release/app-store-release-unsigned.apk app/build/outputs/apk/store/release/SpeakThat-NoUpdater-v${VERSION}.apk
          
          echo "Files renamed successfully"
          ls -la app/build/outputs/apk/github/release/
          ls -la app/build/outputs/apk/store/release/
        
      - name: Upload GitHub APK
        uses: actions/upload-artifact@v4
        with:
          name: SpeakThat-github-release
          path: app/build/outputs/apk/github/release/SpeakThat-v*.apk
          
      - name: Upload Store APK
        uses: actions/upload-artifact@v4
        with:
          name: SpeakThat-store-release
          path: app/build/outputs/apk/store/release/SpeakThat-NoUpdater-v*.apk
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            app/build/outputs/apk/github/release/SpeakThat-v*.apk
            app/build/outputs/apk/store/release/SpeakThat-NoUpdater-v*.apk
          body: |
            ## SpeakThat Release
            
            ### Download Options:
            
            **For direct GitHub users (recommended):**
            - Download `SpeakThat-v*.apk` - Includes auto-updater functionality
            
            **For app stores (F-Droid, Play Store, etc.):**
            - Download `SpeakThat-NoUpdater-v*.apk` - No auto-updater (stores handle updates)
            
            ### What's New:
            - Bug fixes and improvements
            - Enhanced notification handling
            - Improved performance
            
            ### Installation:
            1. Download the appropriate APK for your use case
            2. Enable "Install from unknown sources" in Android settings
            3. Install the APK
            
            ### Notes:
            - GitHub variant includes auto-update functionality
            - Store variant relies on app store updates
            - Both variants are functionally identical except for update handling
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 